<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EHR Blockchain DApp Demo</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i Ethers.js cho t∆∞∆°ng t√°c Blockchain -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
    <!-- T·∫£i CryptoJS cho Keccak256 v√† PBKDF2 (M·∫∑c d√π gi·∫£i m√£ EAX s·∫Ω l√† mock) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            font-family: 'Inter', sans-serif;
        }
        .bg-gradient-header {
            background: linear-gradient(90deg, #1e3a8a 0%, #104e8b 100%);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto shadow-2xl rounded-xl overflow-hidden">
        
        <!-- Header -->
        <header class="bg-gradient-header p-6 text-white">
            <h1 class="text-3xl font-bold mb-1">H·ªá Th·ªëng EHR Blockchain PoC</h1>
            <p class="text-sm opacity-90">Demo truy c·∫≠p d·ªØ li·ªáu y t·∫ø phi t·∫≠p trung v√† b·∫•t bi·∫øn.</p>
        </header>

        <!-- Main Content -->
        <main class="p-6 space-y-6 bg-white">
            
            <!-- C·∫•u h√¨nh -->
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-lg">
                <p class="font-semibold text-blue-800">C·∫•u h√¨nh Hi·ªán t·∫°i (Sepolia Testnet):</p>
                <code class="block text-xs text-blue-700 mt-1 break-all" id="config-info"></code>
            </div>

            <!-- Input & Action -->
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="patientIdInput" placeholder="Nh·∫≠p Patient ID (v√≠ d·ª•: P0001 - P0030)"
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700">
                <button id="fetchButton" onclick="fetchEHR()"
                        class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 disabled:opacity-50">
                    Truy V·∫•n & Gi·∫£i M√£ H·ªì S∆°
                </button>
            </div>
            
            <!-- Tr·∫°ng th√°i -->
            <div id="statusOutput" class="p-3 bg-gray-100 border border-gray-300 rounded-lg text-sm font-medium hidden">
                ƒêang ch·ªù...
            </div>

            <!-- K·∫øt qu·∫£ Metadata -->
            <div id="metadataResult" class="border border-gray-200 p-4 rounded-lg space-y-3 hidden">
                <h3 class="text-lg font-semibold text-gray-800">1. Metadata Blockchain</h3>
                <code class="block text-xs break-all text-gray-600" id="metadataCode"></code>
            </div>
            
            <!-- K·∫øt qu·∫£ Hash Verification -->
            <div id="hashResult" class="border border-gray-200 p-4 rounded-lg space-y-3 hidden">
                <h3 class="text-lg font-semibold text-gray-800">2. X√°c minh Hash IPFS (Security Gate)</h3>
                <div id="hashStatus" class="font-medium"></div>
            </div>

            <!-- K·∫øt qu·∫£ Plaintext -->
            <div id="plaintextResult" class="border border-green-500 bg-green-50 p-4 rounded-lg space-y-3 hidden">
                <h3 class="text-xl font-bold text-green-700">3. D·ªØ Li·ªáu ƒê√£ Gi·∫£i M√£ (Plaintext)</h3>
                <pre class="bg-green-100 p-3 rounded-lg overflow-x-auto text-sm" id="plaintextCode"></pre>
            </div>
            
        </main>
    </div>

    <script>
        // ==========================================================
        // KHAI B√ÅO C·∫§U H√åNH & H·∫∞NG S·ªê
        // ==========================================================
        const PASSPHRASE = "matkhau123";
        const IPFS_GATEWAY = "https://gateway.pinata.cloud/ipfs/";
        const CONTRACT_ADDRESS = "0x3d3A98D067c9004131190FDa942d2DAF26965554";
        const RPC_URL = "https://eth-sepolia.g.alchemy.com/v2/IVo-gRm8mhmFsQ2sWc5CS";
        const USER_ADDRESS = "0x805ebe4EcEB4c6a0434D49EeFa8692deeA274532"; // ƒê·ªãa ch·ªâ gi·∫£ ƒë·ªãnh c√≥ quy·ªÅn
        
        // ABI ch·ªâ bao g·ªìm c√°c h√†m c·∫ßn thi·∫øt (getRecordMetadata, logAccessViewed)
        const ABI = [
            {
                "inputs": [{"internalType": "bytes32","name": "_patientIdHash","type": "bytes32"}],
                "name": "logAccessViewed",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "bytes32","name": "_patientIdHash","type": "bytes32"}],
                "name": "getRecordMetadata",
                "outputs": [
                    {"internalType": "string","name": "cid","type": "string"},
                    {"internalType": "bytes32","name": "hash","type": "bytes32"},
                    {"internalType": "address","name": "owner","type": "address"},
                    {"internalType": "uint256","name": "timestamp","type": "uint256"}
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // D·ªØ li·ªáu Mock (Fallback) - Ch·ªâ d√πng ƒë·ªÉ demo hi·ªÉn th·ªã Plaintext sau khi Hash Check th√†nh c√¥ng
        // D·ªØ li·ªáu n√†y ƒë∆∞·ª£c tr√≠ch t·ª´ file ehr_records_near_fhir (1).json
        const MOCK_PLAINTEXT = {
            "P0001": {
                "resourceType": "EHRRecord",
                "patient": {"id": "P0001", "name": "Nhi√™n ƒê·∫∑ng", "birthDate": "1981-07-09"},
                "diagnosis": "R·ªëi lo·∫°n m·ª° m√°u",
                "status": "ƒê√£ gi·∫£i m√£ th√†nh c√¥ng (Mock Display)"
            },
            "P0030": {
                "resourceType": "EHRRecord",
                "patient": {"id": "P0030", "name": "Y·∫øn Tr·∫ßn", "birthDate": "1959-06-12"},
                "diagnosis": "Suy th·∫≠n",
                "prescription": "Amlodipine 1 vi√™n/ng√†y",
                "status": "ƒê√£ gi·∫£i m√£ th√†nh c√¥ng (Mock Display)"
            }
        };

        // Kh·ªüi t·∫°o Ethers Provider v√† Contract
        let provider, contract; // Lo·∫°i b·ªè bi·∫øn signer kh√¥ng c·∫ßn thi·∫øt
        
        window.onload = () => {
            document.getElementById('config-info').textContent = 
                `Contract: ${CONTRACT_ADDRESS} | RPC: ${RPC_URL} | User Address: ${USER_ADDRESS}`;
            
            try {
                // Kh·ªüi t·∫°o Provider v√† Contract
                provider = new ethers.JsonRpcProvider(RPC_URL);
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
            } catch (error) {
                updateStatus(`‚ùå L·ªói kh·ªüi t·∫°o Web3/Contract: ${error.message}`, 'bg-red-100 text-red-800');
            }
        };

        // ==========================================================
        // H√ÄM H·ªñ TR·ª¢ CRYPTO & WEB3
        // ==========================================================

        function toPatientHash(pid) {
            // S·ª≠ d·ª•ng ethers.js utils ƒë·ªÉ Keccak256
            return ethers.keccak256(ethers.toUtf8Bytes(pid));
        }

        async function verifyHash(downloadedBytes, expectedHash) {
            // T·∫£i v·ªÅ b·∫±ng Fetch API, tr·∫£ v·ªÅ ArrayBuffer, c·∫ßn chuy·ªÉn sang Uint8Array
            const dataBuffer = new Uint8Array(downloadedBytes);
            
            // T√≠nh to√°n SHA-256 (s·ª≠ d·ª•ng Web Crypto API)
            const crypto = window.crypto.subtle;
            if (!crypto) {
                console.error("Web Crypto API kh√¥ng kh·∫£ d·ª•ng. B·ªè qua x√°c minh Hash.");
                return true; // B·ªè qua n·∫øu m√¥i tr∆∞·ªùng kh√¥ng h·ªó tr·ª£
            }

            const hashBuffer = await crypto.digest('SHA-256', dataBuffer);
            const actualHash = '0x' + Array.from(new Uint8Array(hashBuffer))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');

            updateStatus(`  - Hash t·∫£i v·ªÅ (SHA256): ${actualHash.substring(0, 10)}...`);
            updateStatus(`  - Hash mong ƒë·ª£i (BC): ${expectedHash.substring(0, 10)}...`);

            // So s√°nh Hash. Hash t·ª´ BC (expectedHash) l√† bytes32, hash t·ª´ Web Crypto (actualHash) l√† 0x + 64 k√Ω t·ª± hex.
            return actualHash === expectedHash;
        }

        async function updateStatus(message, style = 'bg-gray-100 text-gray-800') {
            const statusElement = document.getElementById('statusOutput');
            statusElement.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'text-red-800', 'text-green-800');
            statusElement.className = `p-3 border border-gray-300 rounded-lg text-sm font-medium ${style}`;
            statusElement.innerHTML += `<p class="mt-1">${new Date().toLocaleTimeString()} - ${message}</p>`;
        }

        function resetUI() {
            document.getElementById('statusOutput').innerHTML = '';
            document.getElementById('statusOutput').classList.remove('hidden');
            document.getElementById('metadataResult').classList.add('hidden');
            document.getElementById('hashResult').classList.add('hidden');
            document.getElementById('plaintextResult').classList.add('hidden');
            document.getElementById('fetchButton').disabled = false;
        }
        
        async function mockLogAccessViewed(pidHash) {
            // ƒê√¢y l√† m√¥ ph·ªèng vi·ªác g·ªçi h√†m logAccessViewed.
            // Trong th·ª±c t·∫ø, c·∫ßn c√≥ Signer v√† Private Key ƒë·ªÉ g·ª≠i TX.
            // V√¨ ch·ªâ l√† DApp Demo, ch√∫ng ta gi·∫£ ƒë·ªãnh giao d·ªãch th√†nh c√¥ng.
            try {
                // Ki·ªÉm tra xem h√†m c√≥ t·ªìn t·∫°i kh√¥ng (ch·ªâ ƒë·ªÉ tr√°nh l·ªói c·ª©ng n·∫øu ABI b·ªã thi·∫øu)
                if (contract.logAccessViewed) {
                     // G·ª≠i m·ªôt cu·ªôc g·ªçi ch·ªâ ƒë·ªçc (call) ƒë·ªÉ ki·ªÉm tra logic h·ª£p ƒë·ªìng (n·∫øu c√≥ require)
                     // N·∫øu kh√¥ng c√≥ require, vi·ªác n√†y s·∫Ω pass. ƒê√¢y l√† m√¥ ph·ªèng t·ªët nh·∫•t c√≥ th·ªÉ.
                     await contract.logAccessViewed.staticCall(pidHash, { from: USER_ADDRESS });
                }
                updateStatus("‚úÖ Ghi Log Truy c·∫≠p (Audit Log) m√¥ ph·ªèng th√†nh c√¥ng.");
            } catch (error) {
                updateStatus(`‚ùå Ghi Log Truy c·∫≠p m√¥ ph·ªèng TH·∫§T B·∫†I. L·ªói: ${error.message}`, 'bg-red-100 text-red-800');
            }
        }

        // ==========================================================
        // H√ÄM CH√çNH: TRUY V·∫§N, T·∫¢I V·ªÄ V√Ä GI·∫¢I M√É
        // ==========================================================

        async function fetchEHR() {
            resetUI();
            document.getElementById('fetchButton').disabled = true;
            const patientId = document.getElementById('patientIdInput').value.trim().toUpperCase();

            if (!patientId || patientId.length < 5) {
                updateStatus("‚ùå Vui l√≤ng nh·∫≠p Patient ID h·ª£p l·ªá (v√≠ d·ª•: P0001).", 'bg-red-100 text-red-800');
                document.getElementById('fetchButton').disabled = false;
                return;
            }

            const pidHash = toPatientHash(patientId);
            let cid, expectedHash;

            try {
                // 1. L·∫§Y METADATA T·ª™ BLOCKCHAIN
                updateStatus(`‚õìÔ∏è Truy v·∫•n Metadata cho Patient ID: ${patientId} (Hash: ${pidHash.substring(0, 10)}...)`);
                
                const metadata = await contract.getRecordMetadata(pidHash, { from: USER_ADDRESS });
                cid = metadata[0];
                expectedHash = metadata[1]; // bytes32
                
                if (!cid || expectedHash === '0x0000000000000000000000000000000000000000000000000000000000000000') {
                    updateStatus("‚ùå L·ªói: CID r·ªóng ho·∫∑c Hash 0x0. H·ªì s∆° kh√¥ng t·ªìn t·∫°i, ch∆∞a c·∫≠p nh·∫≠t CID th·∫≠t, ho·∫∑c kh√¥ng c√≥ quy·ªÅn truy c·∫≠p.", 'bg-red-100 text-red-800');
                    return;
                }
                
                document.getElementById('metadataResult').classList.remove('hidden');
                document.getElementById('metadataCode').textContent = 
                    `CID (IPFS): ${cid}\nHash (SHA256): ${expectedHash}\nOwner: ${metadata[2]}\nTimestamp: ${metadata[3]}`;

                updateStatus(`‚úÖ L·∫•y CID th√†nh c√¥ng: ${cid}`);

                // 2. T·∫¢I FILE ƒê√É M√É H√ìA T·ª™ IPFS
                const url = `${IPFS_GATEWAY}${cid}`;
                updateStatus(`‚òÅÔ∏è ƒêang t·∫£i d·ªØ li·ªáu ƒë√£ m√£ h√≥a t·ª´: ${url}`);
                const response = await fetch(url);
                
                if (!response.ok) {
                    updateStatus(`‚ùå L·ªói t·∫£i IPFS: Status ${response.status} - ${response.statusText}. C√≥ th·ªÉ CID ch∆∞a ƒë∆∞·ª£c Pin.`, 'bg-red-100 text-red-800');
                    return;
                }
                
                const encryptedDataArrayBuffer = await response.arrayBuffer();

                // 3. X√ÅC MINH HASH TO√ÄN V·∫∏N
                document.getElementById('hashResult').classList.remove('hidden');
                updateStatus("üîë ƒêang ti·∫øn h√†nh x√°c minh Hash to√†n v·∫πn (Security Gate)...");
                
                const hashStatusElement = document.getElementById('hashStatus');
                const isHashValid = await verifyHash(encryptedDataArrayBuffer, expectedHash);
                
                if (isHashValid) {
                    hashStatusElement.innerHTML = `<span class="text-green-600">‚úÖ TH√ÄNH C√îNG: Hash d·ªØ li·ªáu t·∫£i v·ªÅ KH·ªöP v·ªõi Hash tr√™n Blockchain.</span>`;
                    updateStatus("‚úÖ X√°c minh Hash th√†nh c√¥ng! D·ªØ li·ªáu ƒë√°ng tin c·∫≠y.");

                    // 4. MOCK GHI LOG TRUY C·∫¨P (Audit Log)
                    mockLogAccessViewed(pidHash);

                    // 5. GI·∫¢I M√É & HI·ªÇN TH·ªä PLAINTEXT (Mock do ph·ª©c t·∫°p c·ªßa EAX mode trong tr√¨nh duy·ªát)
                    const plaintextRecord = MOCK_PLAINTEXT[patientId] || { error: `Kh√¥ng t√¨m th·∫•y n·ªôi dung m·∫´u (Mock) cho ${patientId}` };
                    
                    document.getElementById('plaintextResult').classList.remove('hidden');
                    document.getElementById('plaintextCode').textContent = JSON.stringify(plaintextRecord, null, 2);
                    
                } else {
                    hashStatusElement.innerHTML = `<span class="text-red-600">‚ùå TH·∫§T B·∫†I: Hash d·ªØ li·ªáu KH√îNG KH·ªöP. D·ªØ li·ªáu ƒë√£ b·ªã s·ª≠a ƒë·ªïi ho·∫∑c t·∫£i l·ªói. **KH√îNG GI·∫¢I M√É!**</span>`;
                    updateStatus("‚ùå X√°c minh Hash th·∫•t b·∫°i. Qu√° tr√¨nh d·ª´ng l·∫°i ƒë·ªÉ ƒë·∫£m b·∫£o b·∫£o m·∫≠t.", 'bg-red-100 text-red-800');
                }

            } catch (error) {
                updateStatus(`‚ùå L·ªñI H·ªÜ TH·ªêNG: ${error.message || error}`, 'bg-red-100 text-red-800');
            } finally {
                document.getElementById('fetchButton').disabled = false;
            }
        }
    </script>
</body>
</html>